{% extends "supplements/tab_view_base.html" %}

{% load static %}
{% load perms_helper %}
{% load template_helper %}
{% load compress %}
{% load widget_tweaks %}

{% block extra_pls_css %}
<link rel="stylesheet" type="text/css" href="{% static 'libs/slick/slick.css' %}"/>
<link rel="stylesheet" type="text/css" href="{% static 'libs/slick/slick-theme.css' %}"/>
{% endblock %}

{% block tab_content %}
<div class="tabs-container">
  <ul class="nav nav-tabs scrolling-tabs">
    <li class="nav-item active">
      <a class="nav-link" data-toggle="tab" href="#edit">Edit</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-toggle="tab" href="#info">Info</a>
    </li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade in active m-t" id="edit">
      <form id="user_supplement_form" name="user_supplement_form" method="POST" class="form-horizontal" role="form" enctype="multipart/form-data">
          {% csrf_token %}
          {{ form.non_field_errors }}
          {{ form.action }}
          {{ form.image_data_url }}
          {{ form.upload_url }}
          {{ form.mockup_slug }}
          <canvas id='canvas'></canvas>
          <div class="row">
            <div class="col-md-8">
              {% include "supplements/partials/edit_form.html" %}
              {% block form_action %}
              <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10 col-xs-12">
                  <input type="submit"
                         value="Create Supplement"
                         data-action="approve"
                         class="btn btn-primary confirm-create"
                         data-loading-text="Please wait..."
                         >

                  <input type="submit"
                         value="Save for Later"
                         data-action="save"
                         class="btn btn-primary confirm-create"
                         data-loading-text="Please wait..."
                         >

                  <input type="reset" value="Reset" class="btn btn-default">
                </div>
              </div>
              {% endblock %}
            </div>
            <div class="col-md-4">
              {% include "supplements/partials/images.html" %}
            </div>
          </div>
        </form>
    </div>

    <div class="tab-pane fade m-t" id="info">
      <div class="row">
        <div class="col-md-10">
          <label class="col-sm-3 col-xs-12 control-label">Product Information:</label>
          <div class="col-sm-9 col-xs-12">
            {{ product_information }}
          </div>
        </div>
      </div>

      {% if authenticity_cert %}
      <div class="row m-t">
        <div class="col-md-10">
          <label class="col-sm-3 col-xs-12 control-label">Authenticity Certificate:</label>
          <div class="col-sm-9 col-xs-12">
            <div>
              <div class="image-imitation">
                <embed alt="image" class="img-fluid" src="{{ authenticity_cert }}" type='application/pdf' height="500px" width="100%" />
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block product_footer %}
<div class='row'>
  <div class='col-md-6 m-t'>
    <div class="panel panel-info label-banner">
      <div class="panel-heading label-banner">
        <h3>Label Requirements</h3>
      </div>
      <div class="panel-body">
        <p>
        Before you upload your label please read our guidelines to learn how to 
        present your design and ensure it is approved.
        You can learn more about what you can include in our support portal.
       </p>
       <p><a href="https://help.dropified.com/en/articles/3824485-supplement-label-guidelines" target="_blank" role="button" class="btn btn-primary btn-md">Read Guidelines</a></p>
      </div> 
    </div>
  </div>
</div>

<div id="modal-preview-image" class="modal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">{{ form.mockup_slug.value|title }} Mockup</h4>
      </div>
      <div class="modal-body">
        <div class="row m-t" style="margin: 0 0 0 50px;">
          <img id="mockup" src="" alt="" style="height: 400px;width: 400px;">
        </div>
      </div>
    </div>
  </div>
</div>

{% include "supplements/partials/send_to_store_modal.html" %}
{% include "supplements/partials/label_upload_modal.html" %}

{% endblock %}

{% block extracss %}
{{ block.super }}
<link href="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.9.2/themes/base/jquery-ui.css" rel="stylesheet">
<link href="//cdnjs.cloudflare.com/ajax/libs/plupload/2.1.9/jquery.ui.plupload/css/jquery.ui.plupload.css" rel="stylesheet">
{% endblock %}

{% block extrajs %}
<script type="text/javascript">
    $.fn.bootstrapBtn = $.fn.button.noConflict();
</script>

{% compress js %}
<script type="text/javascript" src="{% static 'libs/slick/slick.min.js' %}"></script>
<script type="text/javascript" src="{% static 'pls/js/common.js' %}"></script>
<script type="text/javascript" src="{% static 'pls/js/supplement.js' %}"></script>
<script type="text/javascript" src="{% static 'pls/js/send_to_store.js' %}"></script>
{% endcompress %}

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/plupload/2.1.9/plupload.full.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/plupload/2.1.9/jquery.ui.plupload/jquery.ui.plupload.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ckeditor/4.5.4/ckeditor.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/pusher/3.2.4/pusher.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/pdf.js/2.3.200/pdf.min.js"></script>

<script type="text/javascript">
var apiData = {{ api_data|safe }};
var storeData = {{ store_data|safe }}
setup_full_editor('id_description');

{% if aws_available %}
$("#uploader").plupload({
    runtimes : 'html5,flash',
    flash_swf_url : '//cdnjs.cloudflare.com/ajax/libs/plupload/2.1.9/Moxie.swf',
    url : "https://{% app_setting 'AWS_STORAGE_BUCKET_NAME' %}.s3.amazonaws.com:443/",
    file_name_name: false,
    multipart: true,
    multipart_params : {
      filename: 'filename',
      utf8: true,
      AWSAccessKeyId: "{% app_setting 'AWS_ACCESS_KEY_ID' %}",
      acl: "public-read",
      policy: "{{aws_policy|escapejs}}",
      signature: "{{aws_signature|escapejs}}",
      key: "uploads/u{{user.id}}/${filename}",
      'Content-Type': 'application/pdf',
    },
    filters : {
        max_file_size : '20mb',
        mime_types: [
            {title : "Label files", extensions : "pdf"}
        ]
    },
    views: {
        list: true,
        thumbs: true,
        active: 'thumbs'
    },
    sortable: true,
    dragdrop: true,
    init: {
        BeforeUpload: function(up, file) {
            var params = up.settings.multipart_params;
            params['Content-Type'] = file.type;

            var name = Math.round(Math.random() * 100) + file.name;
            params.key = "uploads/u{{user.id}}/" + name;
        },
        FileUploaded: function(up, file, info) {
            var key = up.settings.multipart_params.key;
            var url = "https://{% app_setting 'AWS_STORAGE_BUCKET_NAME' %}.s3.amazonaws.com/" + key;
            document.getElementById('user_supplement_form').upload_url.value = url;
            $('.custom-file-label').html(file.name);
            ajaxify_label(file.getNative());
        },
        UploadComplete: function(up, files){
            $('#modal-upload-image').modal('hide');
        }
    }
});
{% endif %}

</script>
{% endblock %}
