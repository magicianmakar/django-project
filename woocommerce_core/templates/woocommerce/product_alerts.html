{% extends "base_woocommerce_core.html" %}

{% load static %}
{% load compress %}
{% load template_helper %}

{% block title %}Alerts{% endblock %}

{% block main-container %}

<div class="row">
    <div class="col-md-12">
         <div class="tabs-container">
            {% include 'home/partial/tabs/product_alerts.html' %}
            <div class="tab-content">
                <div id="tab-1" class="tab-pane active">
                    <div class="panel-body">
                        {% if upsell %}
                        {% if request.user.profile.plan.support_addons %}
                        {% include "common/partial/upsell.html" with addon_id=20 message="Add Alerts to your Plan" only %}
                        {% else %}
                        {% include "common/partial/upsell.html" with addon_id='' message="Please upgrade your Plan to add Alerts" only %}
                        {% endif %}
                        {% endif %}
                        <div class="row">
                            <div class="col-md-8 filter-col">
                                <form id="filter-form" class="form-inline" method="get">
                                    <input type="hidden" name="store" value="{{request.GET.store}}">
                                    <input type="hidden" name="hidden" value="{{request.GET.hidden}}">
                                    <label for="selected-actions" class="filter-col-item">Category:</label>
                                    <select class="form-control filter-col-item" name="category">
                                        <option value=""></option>
                                        <option {% if category == "product:offline" %} selected {% endif %} value="product:offline">Availability</option>
                                        <option {% if category == "variant:quantity" %} selected {% endif %} value="variant:quantity">Quantity</option>
                                        <option {% if category == "variant:price" %} selected {% endif %} value="variant:price">Price</option>
                                        <option {% if category == "variant:var_added" %} selected {% endif %} value="variant:var_added">Variant Added</option>
                                        <option {% if category == "variant:var_removed" %} selected {% endif %} value="variant:var_removed">Variant Removed</option>
                                    </select>
                                    <label for="selected-actions" class="filter-col-item">Product Type:</label>
                                    <input name="product_type" type="text" class="form-control filter-col-item" value="{{product_type}}" placeholder="">
                                    <label for="selected-actions" class="filter-col-item">Product:</label>
                                    <select name="product" id="product" data-store="{{store.id}}">
                                        {% if product %}
                                        <option value="{{product.id}}" selected="">{{product.title|truncatewords:5}}</option>
                                        {% endif %}
                                    </select>
                                    <button id="apply-btn" class="btn btn-primary filter-col-item">Apply</button>
                                </form>
                            </div>
                            <div class="col-md-4 text-right">
                            {% if show_hidden %}
                                <a href="{% url 'woo:product_alerts' %}?store={{ request.GET.store }}" class="btn btn-rounded btn-outline btn-sm expand-btn btn-default btn-reverse active">Archived Alerts</a>
                            {% else %}
                                <a href="{% url 'woo:product_alerts' %}?hidden=1&store={{ request.GET.store }}" class="btn btn-rounded btn-outline btn-sm expand-btn btn-default">Archived Alerts</a>
                            {% endif %}
                                <a data-toggle="dropdown" href="#" aria-expanded="false" class="dropdown-toggle btn btn-circle btn-outline btn-sm expand-btn btn-default"><i class="fa fa-cog"></i></a>
                                <ul class="dropdown-menu dropdown-user">
                                    <li>
                                        <a store-id="{{store.id}}" id="archive-all-alerts" href="#">Archive All Alerts</a>
                                    </li>
                                    <li>
                                        <a store-id="{{store.id}}" id="delete-all-alerts" href="#">Delete All Alerts</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <table class="table alert-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Date</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in product_changes %}
                                    {% for change in item.changes.product.offline %}
                                        {% if forloop.first %}
                                        <tr class="header" alert-id="{{item.id}}">
                                            <td class="category">Availability</td>
                                            <td class="details-toggle">
                                                {% if not change.new_value %}
                                                    Product
                                                    <a href="{{item.qelem.product_link}}" target="_blank" class="itooltip" title="{{item.qelem.product.title}}">{{item.qelem.product.title|truncatewords:5}}</a>
                                                    Is now <b style="color:green">Online</b>
                                                {% else %}
                                                    Product
                                                    <a href="{{item.qelem.product_link}}" target="_blank" class="itooltip" title="{{item.qelem.product.title}}">{{item.qelem.product.title|truncatewords:5}}</a>
                                                    Is now <b style="color:red">Offline</b>
                                                {% endif %}
                                            </td>
                                            <td>{{item.qelem.updated_at|date}}</td>
                                            <td>
                                                <a class="btn btn-default btn-outline btn-xs view-details" href="#">View Details</a>
                                                <a class="btn btn-success btn-outline btn-xs open-product-in" product-id="{{item.product.id}}" woo-link="{{item.woo_link|default:''}}" original-link="{{item.original_link}}" href="#">Open Product</a>

                                                <a class="btn btn-primary btn-outline btn-xs archive-alert" alert-id="{{item.id}}" href="#">Archive</a>
                                            </td>
                                        </tr>
                                        <tr class="details" alert-id="{{item.id}}">
                                        {% endif %}
                                        {% if forloop.last %}
                                        </tr>
                                        {% endif %}
                                    {% endfor %}

                                    {% for change in item.changes.variants.price %}
                                        {% if forloop.first %}
                                        <tr class="header" alert-id="{{item.id}}" >
                                            <td class="category">Price</td>
                                            <td class="details-toggle">The <b>Price</b> of one or more Variants of <a href="{{item.qelem.product_link}}" target="_blank" class="itooltip" title="{{item.qelem.product.title}}">{{item.qelem.product.title|truncatewords:5}}</a> has changed</td>
                                            <td>{{item.qelem.updated_at|date}}</td>
                                            <td>
                                                <a class="btn btn-default btn-outline btn-xs view-details" href="#">View Details</a>
                                                <a class="btn btn-success btn-outline btn-xs open-product-in" product-id="{{item.product.id}}" woo-link="{{item.woo_link|default:''}}" original-link="{{item.original_link}}" href="#">Open Product</a>

                                                <a class="btn btn-primary btn-outline btn-xs archive-alert" alert-id="{{item.id}}" href="#">Archive</a>
                                            </td>
                                        </tr>
                                        <tr class="details" alert-id="{{item.id}}">
                                            <td class="well" colspan="4">
                                                <div class="row" style="margin-bottom: 12px; border-bottom: 1px solid rgb(230, 230, 230);">
                                                    <div class="col-md-offset-1 col-md-3 var-name"><b>Variant</b></div>
                                                    <div class="col-md-2"></div>
                                                    <div class="col-md-2"><b>Old Price</b></div>
                                                    <div class="col-md-2"><b>New Price</b></div>
                                                    <div class="col-md-2"><b>WooCommerce</b></div>
                                                </div>

                                        {% endif %}
                                                <div class="row">
                                                    <div class="col-md-offset-1 col-md-3 var-name">{{change.sku_readable}}</div>
                                                    <div class="col-md-2"> {% price_diff change.old_value change.new_value %}</div>
                                                    <div class="col-md-2">{% money_format change.old_value store %}</div>
                                                    <div class="col-md-2">{% money_format change.new_value store %}</div>
                                                    <div class="col-md-2">
                                                    {% if change.woo_value_label %}
                                                    {{ change.woo_value_label }}
                                                    {% else %}
                                                    {% money_format change.woo_value store %}
                                                    {% endif %}
                                                    </div>
                                                </div>
                                        {% if forloop.last %}
                                            </td>
                                        </tr>
                                        {% endif %}
                                    {% endfor %}

                                    {% for change in item.changes.variants.quantity %}
                                        {% if forloop.first %}
                                        <tr class="header" alert-id="{{item.id}}" >
                                            <td class="category">Quantity</td>
                                            <td class="details-toggle">The <b>Quantity</b> of one or more Variants of <a href="{{item.qelem.product_link}}" target="_blank" class="itooltip" title="{{item.qelem.product.title}}">{{item.qelem.product.title|truncatewords:5}}</a> has changed</td>
                                            <td>{{item.qelem.updated_at|date}}</td>
                                            <td>
                                                <a class="btn btn-default btn-outline btn-xs view-details" href="#">View Details</a>
                                                <a class="btn btn-success btn-outline btn-xs open-product-in" product-id="{{item.product.id}}" woo-link="{{item.woo_link|default:''}}" original-link="{{item.original_link}}" href="#">Open Product</a>

                                                <a class="btn btn-primary btn-outline btn-xs archive-alert" alert-id="{{item.id}}" href="#">Archive</a>
                                            </td>
                                        </tr>
                                        <tr class="details" alert-id="{{item.id}}">
                                            <td class="well" colspan="4">
                                                <div class="row" style="margin-bottom: 12px; border-bottom: 1px solid rgb(230, 230, 230);">
                                                    <div class="col-md-offset-1 col-md-3 var-name"><b>Variant</b></div>
                                                    <div class="col-md-2"></div>
                                                    <div class="col-md-2"><b>Old Quantity</b></div>
                                                    <div class="col-md-2"><b>New Quantity</b></div>
                                                    <div class="col-md-2"><b>WooCommerce</b></div>
                                                </div>

                                        {% endif %}
                                                <div class="row">
                                                    <div class="col-md-offset-1 col-md-3 var-name">{{change.sku_readable}}</div>
                                                    <div class="col-md-2">{% price_diff change.old_value change.new_value True %}</div>
                                                    <div class="col-md-2">{{change.old_value}}</div>
                                                    <div class="col-md-2">{{change.new_value}}</div>
                                                    <div class="col-md-2">{{change.woo_value}}</div>
                                                </div>
                                        {% if forloop.last %}
                                            </td>
                                        </tr>
                                        {% endif %}
                                    {% endfor %}

                                    {# New Variants #}
                                    {% for change in item.changes.variants.var_added %}
                                        {% if forloop.first %}
                                        <tr class="header" alert-id="{{item.id}}" >
                                            <td class="category">New Variant</td>
                                            <td class="details-toggle">A <b>new variant</b> has been added to <a href="{{item.qelem.product_link}}" target="_blank" class="itooltip" title="{{item.qelem.product.title}}">{{item.qelem.product.title|truncatewords:5}}</a></td>
                                            <td>{{item.qelem.updated_at|date}}</td>
                                            <td>
                                                <a class="btn btn-default btn-outline btn-xs view-details" href="#">View Details</a>
                                                <a class="btn btn-success btn-outline btn-xs open-product-in" product-id="{{item.product.id}}" woo-link="{{item.woo_link|default:''}}" original-link="{{item.original_link}}" href="#">Open Product</a>

                                                <a class="btn btn-primary btn-outline btn-xs archive-alert" alert-id="{{item.id}}" href="#">Archive</a>
                                            </td>
                                        </tr>
                                        <tr class="details" alert-id="{{item.id}}">
                                            <td class="well" colspan="4">
                                                <div class="row" style="margin-bottom: 12px; border-bottom: 1px solid rgb(230, 230, 230);">
                                                    <div class="col-md-offset-1 col-md-3 var-name"><b>Variant</b></div>
                                                    <div class="col-md-2"></div>
                                                </div>

                                        {% endif %}
                                                <div class="row">
                                                    <div class="col-md-offset-1 col-md-3 var-name" style="color:green">
                                                        {{change.sku_readable}}
                                                    </div>
                                                    <div class="col-md-2"></div>
                                                </div>
                                        {% if forloop.last %}
                                            </td>
                                        </tr>
                                        {% endif %}
                                    {% endfor %}

                                    {# Removed Product Variants #}
                                    {% for change in item.changes.variants.var_removed %}
                                        {% if forloop.first %}
                                        <tr class="header" alert-id="{{item.id}}" >
                                            <td class="category">Removed Variant</td>
                                            <td class="details-toggle">A variant has been removed from <a href="{{item.qelem.product_link}}" target="_blank" class="itooltip" title="{{item.qelem.product.title}}">{{item.qelem.product.title|truncatewords:5}}</a></td>
                                            <td>{{item.qelem.updated_at|date}}</td>
                                            <td>
                                                <a class="btn btn-default btn-outline btn-xs view-details" href="#">View Details</a>
                                                <a class="btn btn-success btn-outline btn-xs open-product-in" product-id="{{item.product.id}}" woo-link="{{item.woo_link|default:''}}" original-link="{{item.original_link}}" href="#">Open Product</a>

                                                <a class="btn btn-primary btn-outline btn-xs archive-alert" alert-id="{{item.id}}" href="#">Archive</a>
                                            </td>
                                        </tr>
                                        <tr class="details" alert-id="{{item.id}}">
                                            <td class="well" colspan="4">
                                                <div class="row" style="margin-bottom: 12px; border-bottom: 1px solid rgb(230, 230, 230);">
                                                    <div class="col-md-offset-1 col-md-3 var-name"><b>Variant</b></div>
                                                    <div class="col-md-2"></div>
                                                </div>

                                        {% endif %}
                                                <div class="row">
                                                    <div class="col-md-offset-1 col-md-3 var-name" style="color:red">
                                                        {{change.sku_readable}}
                                                    </div>
                                                    <div class="col-md-2"></div>
                                                </div>
                                        {% if forloop.last %}
                                            </td>
                                        </tr>
                                        {% endif %}

                                    {% endfor %}
                                {% empty %}
                                    <tr>
                                        <td class="text-center" colspan="4">
                                            <i>No alerts to display at this time</i>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        {% include "partial/paginator.html" %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extracss %}
{% compress css %}
<link href="{% static 'libs/bower_components/select2/dist/css/select2.min.css' %}" rel="stylesheet">
{% endcompress %}
<style type="text/css">
    tbody tr.header {
        height: 50px !important;
    }

    tbody tr td {
        vertical-align: middle !important;
    }

    tr td.category {
        font-weight: bold;
    }

    .details {
        display: none;
    }

    .var-name {
        text-align: right;
    }

    {% if request.GET.hidden %}
    .archive-alert {
        display:none;
    }
    {% endif %}

    .filter-col {
        display: flex;
        align-items: center;
    }

    .filter-col .filter-col-item {
        margin-right: 5px;
    }

    .filter-col select {
        padding-top: 2px;
        display: inline-block;
        width: 191px;
    }

    .select2-results .select2-results__options .select2-results__option {
        min-height: 51px;
        padding: 0;
        border-bottom: 1px solid #ccc;
    }
    .select2-results .select2-results__options .select2-results__option img {
        height: 50px;
        float: left;
        margin-right: 5px;
    }
    .select2.select2-container.select2-container--default {
        width: 300px !important;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__rendered li {
        padding: 3px 0 0 10px !important;
    }
    .select2-container--default .select2-selection--multiple {
        border: 1px solid #e5e6e7 !important;
        border-radius: 0 !important;
    }
    .select2-container--default.select2-container--disabled .select2-selection--multiple {
        background-color: #fff;
    }
    .select2-container--default .select2-selection--single {
        border: 1px solid #e5e6e7;
        border-radius: 1px;
        height: 34px;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 32px;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 32px;
    }
    .select2-dropdown {
        border: 1px solid #e5e6e7;
        z-index: 1200;
    }
    .select2-results__option--highlighted a {
        color: white;
    }
</style>
{% endblock %}

{% block extrajs %}
{% compress js %}
<script type="text/javascript" src="{% static 'libs/bower_components/handlebars/handlebars.min.js' %}"></script>
<script type="text/javascript" src="{% static 'libs/bower_components/select2/dist/js/select2.full.min.js' %}"></script>
<script type="text/javascript" src="{% static 'woocommerce/js/product_alerts.js' %}"></script>
{% endcompress %}
{% endblock %}
