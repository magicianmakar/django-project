{% extends "base.html" %}

{% load static %}

{% block main-container %}

<div class="row">
    <div class="col-md-8 col-md-offset-2">
<div class="ibox float-e-margins">
<!--     <div class="ibox-title">
        <h5>Product View<small></small></h5>
        <div class="ibox-tools">
            <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
        </div>
    </div> -->
    <div class="ibox-content">

         <div class="tabs-container">
            <ul class="nav nav-tabs">
                <li class="active"><a data-toggle="tab" href="#tab-1"><i class="fa fa-edit"></i> Saved Product</a></li>
                {% if original %}
                <li class=""><a data-toggle="tab" href="#tab-2"><i class="fa fa-history"></i>Original</a></li>
                {% endif %}
                {% if product.original_product_source %}
                <li class=""><a data-toggle="tab" href="#tab-3"><i class="fa fa-file-o"></i>Shipping Method</a></li>
                {% endif %}
                <li class=""><a data-toggle="tab" href="#tab-4"><i class="fa fa-file-o"></i>Notes</a></li>
            </ul>
            <div class="tab-content">
                <div id="tab-1" class="tab-pane active">
                    <div class="panel-body">
        <!-- Product view -->
        <div class=" row">
            <div class="form-group col-xs-12">
                <label for="product-title">Title</label>
                <textarea class="form-control" id="product-title" placeholder="Product Title"></textarea>
            </div>
            <div class="form-group col-xs-4">
                <label for="product-price">Price</label>
                <div class="input-group">
                    <span class="input-group-addon">$</span>
                    <input type="text" class="form-control" id="product-price" placeholder="Product Price">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-xs-6">
                <label for="product-type">Type</label>
                <input type="text" class="form-control" id="product-type" placeholder="Product Type">
            </div>
        </div>

        <div class="row">
            <div class="form-group col-xs-6">
                <label for="store-select">Export to</label>
                <select id="store-select"  class="form-control" _style="width: 30%">
                {% for i in request.user.shopifystore_set.all %}
                    <option value="{{i.id}}">{{i.title}}</option>
                {% endfor %}
                </select>
            </div>

            <div id="more-options" class="col-xs-12">
                <div class="childs" style="">
                    <div class="row">
                    <div class="form-group col-xs-6">
                        <label for="product-type">Weight</label>
                        <input type="text" class="form-control" id="product-weight" placeholder="Product Weight">
                    </div>

                    <div class="form-group col-xs-3" style="padding-top: 24px">
                        <select name="product-weight-unit" id="product-weight-unit" class="form-control">
                            <option value="g" {% if product.product.weight_unit == 'g' %}selected="selected"{% endif %}>g</option>
                            <option value="kg" {% if product.product.weight_unit == 'kg' %}selected="selected"{% endif %}>kg</option>
                            <option value="oz" {% if product.product.weight_unit == 'oz' %}selected="selected"{% endif %}>oz</option>
                            <option value="lb" {% if product.product.weight_unit == 'lb' %}selected="selected"{% endif %}>lb</option>
                        </select>
                    </div>
                    </div>

                    <div class="row">
                        <div class="form-group col-xs-6">
                            <label for="product-type">Compare at price</label>
                            <input type="text" class="form-control" id="product-compare-at" placeholder="" value="{{product.product.compare_at_price|default:''}}">
                        </div>
                    </div>

                    <div class="row">
                        <div class="form-group col-xs-6">
                            <label for="product-type">Tags</label>
                            <input type="text" class="form-control" value="{{ product.product.tags|default:'' }}" id="product-tag" placeholder="Product Tags">
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-xs-6">
                            <label for="">Variants</label>
                        </div>
                    </div>
                    <div id="variants" class="row well" style="margin:5px 0px 10px 0;padding: 20px 0 0px;">
                        <div class="variant-simple form-group col-xs-10" style="display:none">
                            <input type="text" class="form-control" id="product-variant-name" style="width: 150px" placeholder="Title">
                            <input type="text" class="form-control" id="product-variant-values" style="margin: 10px 0px;" placeholder="Values (separeted by comma)">
                            <a href="#" class="btn btn-danger btn-xs remove-variant">Remove</a>
                        </div>
                        <div class="area col-xs-12">
                        </div>
                        <div class="col-xs-12" style="margin: 10px 0;text-align: right">
                            <a href="#" class="btn btn-success btn-xs add-variant">Add Variant</a>
                        </div>
                    </div>

                    <div class="form-group col-xs-12">
                        <label for="product-visible">
                            <input type="checkbox" class="" id="product-visible" {% if product.product.published %} checked="checked"{% endif %}>
                            Make Product Visible
                        </label>
                    </div>

                    <div class="form-group col-xs-12">
                        <input id="product-description" type="hidden" name="content">
                        <trix-editor id="trix-description" input="product-description"></trix-editor>
                    </div>
                </div>
            </div>

            <div class="buttons col-xs-12">
                <div class="row text-center" id="var-images">
                </div>

                <div class="row">
                    <div class="col-xs-12 text-right" style="margin-top: 15px;">
                        {% if images_upload %}
                        <button class="btn btn-success btn-xs" data-toggle="modal" data-target="#modal-upload-image">
                            <i class="fa fa-upload"></i> Upload Image
                        </button>
                        {% endif %}
                        <button class="btn btn-success btn-xs add-images-btn " data-toggle="modal" data-target="#modal-add-image">More images</button>
                    </div>
                </div>
            </div>

            <div class="buttons col-xs-12">
                <p>
                    <button id="export-btn" target="shopify" type="button" class="btn btn-primary" data-loading-text="Sending...">Send to Shopify</button>
                    <button id="save-for-later-btn" target="save-for-later" type="button" class="btn btn-primary" data-loading-text="Saving...">Save for later</button>
                    <button id="view-btn" type="button" class="btn btn-info" style="display:none">View in Shopify</button>
                    <button id="btn-variants-img" type="button" class="btn btn-success" style="display:none">Setup Variants Images</button>

                    {% if product.product.original_url %}
                        <a class="btn btn-outline btn-default btn-sm pull-right" href="{{product.product.original_url}}" target="_blank"><i class="fa fa-external-link"></i> Original Product: {{product.source}}</a>
                    {% endif %}

                </p>
            </div>
        </div>
        <!-- / Product view -->

            </div> <!-- / #tab-1 -->
        </div>
        {% if original %}
        <div id="tab-2" class="tab-pane">
            <div class="panel-body">
        <!-- Product view -->
        <div class=" row">
            <div class=" row">
                <div class="col-xs-8" style="margin-left: 15px">
                    <dl>
                        <dt>Title</dt>
                        <dd>{{original.title}}</dd>
                    </dl>
                </div>
                {% if product.product.original_url %}
                <div class="col-xs-3">
                    <a class="btn btn-outline btn-default btn-sm pull-right" href="{{product.product.original_url}}" target="_blank"><i class="fa fa-external-link"></i> Original Product: {{product.source}}</a>
                </div>
                {% endif %}
            </div>
            <div class="col-xs-4">
                <dl>
                    <dt>Price</dt>
                    <dd>${{original.price}}</dd>
                </dl>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-6">
                <dl>
                    <dt>Type</dt>
                    <dd>{{original.type}}</dd>
                </dl>
            </div>
        </div>

        <div class="row">
            <div class="col-xs-12">
                {% if original.weight %}
                <div class="row">
                    <div class="col-xs-6">
                        <dl>
                            <dt>Weight</dt>
                            <dd>{{original.weight}} {{product.product.weight_unit}}</dd>
                        </dl>
                    </div>
                </div>
                {% endif %}

                {% if original.compare_at_price %}
                <div class="row">
                    <div class="col-xs-6">
                        <dl>
                            <dt>Compare at price</dt>
                            <dd>${{original.compare_at_price}}</dd>
                        </dl>
                    </div>
                </div>
                {% endif %}

                {% if original.tags %}
                <div class="row">
                    <div class="col-xs-6">
                        <dl>
                            <dt>Tags</dt>
                            <dd>{{original.tags}}</dd>
                        </dl>
                    </div>
                </div>
                {% endif %}

                <div class="row">
                    <div class="col-xs-12">
                        <strong>Images</strong>
                        <div class="row  text-center" id="var-images">
                            {% for item in product.images %}
                            <div class="col-xs-3" style="margin-top: 15px">
                                <img src="{{item}}" class="var-image" />
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <br>
                <hr>
                <div class="row original-description">
                    <div class="col-xs-12">
                        <strong>Description</strong>
                        <p>{{original.description|safe}}</p>
                    </div>
                </div>

            </div>
        </div>
        <!-- / Product view -->
            </div>
        </div>
        {% endif %}
        {% if product.original_product_source %}
        <div id="tab-3" class="tab-pane">
            <div class="panel-body">
                <div class="row">
                    <div class="form-group col-xs-12">
                        <iframe src="/shipping/info?id={{product.original_product_id}}" style="width: 100%; height: 600px; border: 0px none #ccc"></iframe>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        <div id="tab-4" class="tab-pane">
            <div class="panel-body">
                <div class="row">
                    <div class="form-group col-xs-12">
                        <input id="product-notes" type="hidden" name="content-notes">
                        <trix-editor id="trix-notes" input="product-notes">dsd</trix-editor>
                    </div>
                    <div class="form-group col-xs-12">
                        <button id="save-product-notes" class="btn btn-success"><i class="fa fa-check"></i> Save Notes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    </div> <!-- / .ibox-content -->
</div>
    </div>
</div>

<div id="modal-add-image" class="modal fade" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title">Select Image to add</h4>
          </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="row">
                        {% for item in original.extra_images %}
                            {% if forloop.counter0|divisibleby:"4" %}
                            <div class="col-xs-12"></div>
                            {% endif %}

                            <div class="col-xs-3 add-var-image-block">
                                <img src="{{item}}" class="add-var-image" />
                            </div>
                        {% endfor %}
                        </div>

                        <div class="description-images-add" class="row">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline btn-default" data-dismiss="modal">Close</button>
              </div>
        </div>
    </div>
</div>

<div id="modal-upload-image" class="modal fade" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title">Image upload</h4>
          </div>
            <div class="modal-body">
                <div id="uploader"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extracss %}
<link href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" rel="stylesheet">
<link href="//cdnjs.cloudflare.com/ajax/libs/plupload/2.1.8/jquery.ui.plupload/css/jquery.ui.plupload.css" rel="stylesheet">

<style type="text/css">
.buttons {
    /*text-align: right;*/
    margin-top: 20px;
    margin-bottom: 25px;
}

.buttons .export, .buttons .view{
    padding: 10px;
    border-radius: 5px;
    cursor: pointer;
}

.buttons .export {
    border: 1px solid #A0E7A3;
    background-color: rgb(213, 255, 213);
}

.buttons .view {
    border: 1px solid #A0C9E7;
    background-color: rgb(213, 255, 253);
}


.var-image, .add-var-image {
    border: 1px solid #ccc;
    padding: 5px;
    width: 100px;
    cursor: pointer;
}

.var-image:hover, .add-var-image:hover {
    border: 1px solid #000;
}

.var-image-disabled {
    opacity: 0.3;
}

.var-image-block, .add-var-image-block {
    margin-top: 15px;
}
</style>
{% endblock %}

{% block extrajs %}
<script type="text/javascript" src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/plupload/2.1.8/plupload.full.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/plupload/2.1.8/jquery.ui.plupload/jquery.ui.plupload.min.js"></script>

<script type="text/javascript">

var api_base = '';
var product = {{product.data|safe}};

function removeVariant(e) {
    e.preventDefault();

    $(this).parent().remove();

    $('#variants .area').append(v);
};

function showProductInfo(rproduct) {
    product = rproduct;
    if (product) {
        $('#product-title').val(product.title);
        $('#product-price').val(product.price);
        $('#product-type').val(product.type);
        $('#product-tag').val(product.tags);
        $('#product-compare-at').val(product.compare_at_price);

        if (product.variants.length) {
            $.each(product.variants, function(i, el) {
                var v = $('#variants .variant-simple').clone();
                v.removeClass('variant-simple');
                v.addClass('variant');
                v.find("a.remove-variant").click(removeVariant);
                v.show();

                v.find('#product-variant-name').val(el.title);
                v.find('#product-variant-values').val(el.values.join(','));

                $('#variants .area').append(v);
            });
        }

        if (product.weight) {
            $('#product-weight').val(product.weight);
        }

        if (product.description) {
            setTimeout(function() {
                var element = document.querySelector("#trix-description");
                element.editor.setSelectedRange([0, 0])
                element.editor.insertHTML(product.description);
            }, 1000);
        }

        renderImages();
    }
}

$("a.add-variant").click(function (e) {
    e.preventDefault();

    var v = $('#variants .variant-simple').clone();
    v.addClass('variant');
    v.removeClass('variant-simple');
    v.show();
    v.find("a.remove-variant").click(removeVariant);
    // v.find('#product-variant-name').val(product.variants_title);
    // v.find('#product-variant-values').val(product.variants_values.join(','));

    $('#variants .area').append(v);
});

function removeVariant(e) {
    e.preventDefault();

    $(this).parent().remove();

    $('#variants .area').append(v);
};

$('#export-btn').click(function () {
    var btn = $(this);
    var target = btn.attr('target');

    btn.button('loading')

    var api_url = $('#store-select').val();

    if (!api_url || api_url.length==0) {
        alert('Please choose a Shopify store first!');
        return;
    // } else {
        // api_url = api_url + '/admin/products.json';
    }

    var api_data = {
      "product": {
        "title": $('#product-title').val(),
        "body_html": $('#product-description').val(),
        "product_type": $('#product-type').val(),
        "vendor": "",
        "published": $('#product-visible')[0].checked,
        "tags": $('#product-tag').val(),
        "variants": [],
        "options": [],
        "images" :[]
      }
    };

    if (product.images) {
        for (var i=0; i<product.images.length; i++) {
            api_data.product.images.push({
                src: product.images[i]
            })
        }
    }

    if ($('#variants .variant').length==0) {
        var vdata = {
            "price": parseFloat($('#product-price').val()),
        };

        if ($('#product-compare-at').val().length) {
            vdata.compare_at_price = parseFloat($('#product-compare-at').val());
        }

        if ($('#product-weight').val().length) {
            vdata.weight = parseFloat($('#product-weight').val());
            vdata.weight_unit = $('#product-weight-unit').val();
        }

        api_data.product.variants.push(vdata);

    } else {
        var vars_list = $('#product-variant-values').val().split(',');

        $('#variants .variant').each(function (i, el) {
            var vals = $(el).find('#product-variant-values').val().split(',');
            if (vals.length>1) {
                api_data.product.options.push({
                    'name': $(el).find('#product-variant-name').val(),
                    'values': vals
                });
            }
        });

        var vars_list = [];
        $('#variants .variant').each(function (i, el) {
            var vals = $(el).find('#product-variant-values').val().split(',');
            if (vals.length>1) {
                vars_list.push(vals);
            }
        });

        if (vars_list.length>0) {
            vars_list = allPossibleCases(vars_list);
            for (var i=0; i<vars_list.length; i++) {
                var title = vars_list[i].join ? vars_list[i].join(' & ') : vars_list[i];

                var vdata = {
                    "price": parseFloat($('#product-price').val()),
                    "title": title,
                };

                if (typeof(vars_list[i]) == "string") {
                    vdata["option1"] = vars_list[i];
                } else {
                    $.each(vars_list[i], function (j, va) {
                        vdata["option"+(j+1)] = va;
                    });
                }

                if ($('#product-compare-at').val().length) {
                    vdata.compare_at_price = parseFloat($('#product-compare-at').val());
                }

                if ($('#product-weight').val().length) {
                    vdata.weight = parseFloat($('#product-weight').val());
                    vdata.weight_unit = $('#product-weight-unit').val();
                }

                api_data.product.variants.push(vdata);
            }
        } else {
            alert('Variants should have more than one value separated by comma (,)');
            btn.button('reset');
            return;
        }
    }

    $.ajax({
        url: api_base + '/api/' + target,
        type: 'POST',
        data: JSON.stringify ({
            'product': {{product.id}},
            'store': api_url,
            'data': JSON.stringify(api_data),
        }),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        context: {btn: this},
        success: function (data) {
            $(this.btn).button('reset');

            if ('product' in data) {
                if (data.product.data) {
                    $('#btn-variants-img').prop('store-id', $('#store-select').val());
                    $('#btn-variants-img').prop('product-id', data.product.data.id);
                    $('#btn-variants-img').show();
                }

                $("#view-btn").attr("shopify-id", data.product.id);
                $("#view-btn").attr("shopify-url", data.product.url);
                $("#view-btn").show();
                $('#export-btn, #save-for-later-btn').hide();
            }  else {
                $("body").append($('<span>', {text: 'Export Error'+('error' in data ? ': '+data.error : ': Unknow error')}));
            }
        },
        error: function (data) {
            console.log(data);
            $(this.btn).button('reset');

            $("body").append($('<span>', {text: 'Export Error: Unknow error'}));
        }

    });
});

$('#save-for-later-btn').click(function (e) {
    var btn = $(this);
    var target = btn.attr('target');

    btn.button('loading')

    var api_url = $('#store-select').val();

    if (!api_url || api_url.length==0) {
        alert('Please choose a Shopify store first!');
        return;
    }

    var api_data = {
        'title': $('#product-title').val(),
        'description': $('#product-description').val(),
        'price': parseFloat($('#product-price').val()),
        'compare_at_price': parseFloat($('#product-compare-at').val()),
        'images': product.images,
        'original_url': product.original_url,
        'type': $('#product-type').val(),
        'tags': $('#product-tag').val(),
        'weight': parseFloat($('#product-weight').val()),
        'weight_unit': $('#product-weight-unit').val(),
        'published': $('#product-visible').prop('checked'),

        'variants': []
    }



    if ($('#variants .variant').length) {
        $('#variants .variant').each(function (i, el) {
            api_data.variants.push({
                'title': $(el).find('#product-variant-name').val(),
                'values': $(el).find('#product-variant-values').val().split(',')
            });

        });
    }

    $.ajax({
        url: api_base + '/api/' + target,
        type: 'POST',
        data: JSON.stringify ({
            'product': {{product.id}},
            'store': api_url,
            'data': JSON.stringify(api_data),
        }),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        context: {btn: this},
        success: function (data) {
            $(this.btn).button('reset');

            if ('product' in data) {
                $("#view-btn").attr("shopify-id", data.product.id);
                $("#view-btn").attr("shopify-url", data.product.url);
            }  else {
                $("body").append($('<span>', {text: 'Export Error'+('error' in data ? ': '+data.error : ': Unknow error')}));
            }
        },
        error: function (data) {
            console.log(data);
            $(this.btn).button('reset');

            $("body").append($('<span>', {text: 'Export Error: Unknow error'}));
        }
    });
});

$("#view-btn").click(function () {
    window.open($(this).attr('shopify-url'), '_blank');
});

function matchImagesWithExtra() {
    $('#modal-add-image .extra-added').remove();
    $('#modal-add-image .add-var-image-block').each(function(i, el) {
            if (product.images.indexOf($('img', el).attr('src')) != -1) {
                $(el).append($('<img class="extra-added" src="//i.imgur.com/HDg5nrv.png" style="position: absolute;left: 16px;top: 1px;border-radius: 0 0 8px 0;background-color: #fff;">'));
            }
    });
}

function imageClicked(e) {
    var imageID = $(this).parent().find('img').attr('image-id');
    var new_images = [];

    for (var i = 0; i < product.images.length; i++) {
        if (i != imageID) {
            new_images.push(product.images[i]);
        }
    };

    product.images = new_images;
    $(this).parent().remove();

    renderImages();
}

$('.var-image-block button').click(imageClicked);

$('.var-image-block').mouseenter(function() {
    $(this).find('button').show();
})
.mouseleave(function() {
    $(this).find('button').fadeOut();
});

$('#btn-variants-img').click(function (e) {
    var store_id = $('#btn-variants-img').prop('store-id');
    var product_id = $('#btn-variants-img').prop('product-id');

    window.location.href = '/product/variants/'+store_id+'/'+product_id;
});

$('#save-product-notes i').hide();
$('#save-product-notes').click(function (e) {
    var btn = $(this);

    btn.button('loading');

    $.ajax({
        type: 'POST',
        url: '/api/product-notes',
        context: btn,
        data: {
            'notes': $('#product-notes').val(),
            'product': {{product.id}},
        },
        success: function(data) {
            if (data.status == 'ok') {
                setTimeout(function () {
                    btn.find('i').slideDown(300, function () {
                        setTimeout(function () {
                            $('i', btn).slideUp();
                        }, 1000);
                    });
                }, 100);
            } else {
                alert('Server Error');
            }
        },
        error: function(data) {
            alert('Server Error');
        },
        complete: function() {
            btn.button('reset');
        }
    });
});

$('#modal-add-image').on('show.bs.modal', function (e) {
    $('#modal-add-image .description-images-add').empty();
    var counter=0;
    $('.original-description img').each(function (i, el) {
        if (product_extra_images.indexOf($(el).attr('src'))==-1) {
            if(counter%4==0) {
                $('.description-images-add').append($('<div class="col-xs-12"></div>'));
            }

            var d = $('<div>', {class:'col-xs-3 add-var-image-block','image-url': $(el).attr('src')});
            var img = $('<img>', {src: $(el).attr('src'), class: 'add-var-image', 'image-url': $(el).attr('src'), 'style':''});
            d.append(img);

            img.click(function (e) {
                var imageIdx = product.images.indexOf($(this).attr('src'));
                if (imageIdx == -1) {
                    product.images.push($(this).attr('src'));
                } else {
                    var images = [];

                    for (var i = 0; i < product.images.length; i++) {
                        if (i!=imageIdx) {
                            images.push(product.images[i]);
                        }
                    };

                    product.images = images;
                }

                renderImages();
            });

            $('.description-images-add').append(d);
            counter++;
        }
    });

    matchImagesWithExtra();
});

$('#modal-add-image .add-var-image').click(function (e) {
    product.images.push($(this).attr('src'));
    renderImages();
});

{% if images_upload %}

$('#modal-upload-image').on('show.bs.modal', function (e) {
    $('.upload-image-btn').button('reset');
    $('#file_input').prop('value', '');
});

$('.upload-image-btn').click(function (e) {
    var files = document.getElementById("file_input").files;
    var file = files[0];
    if(file == null){
        alert("No file selected.");
    }
    else{
        $(this).button('loading');
        get_signed_request(file);
    }
});

function get_signed_request(file){
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/upload/sign_s3?file_name=uploads/u{{user.id}}/"+file.name+"&file_type="+file.type);
    xhr.onreadystatechange = function(){
        if(xhr.readyState === 4) {
            if(xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                if ('error' in response && typeof(response.error)=='string') {
                    alert('Upload error: '+response.error);
                } else {
                    upload_file(file, response.signed_request, response.url);
                }
            } else {
                alert("Could not get signed URL.");
            }

            $('.upload-image-btn').button('reset');
        }
    };
    xhr.send();
}

function upload_file(file, signed_request, url){
    var xhr = new XMLHttpRequest();
    xhr.open("PUT", signed_request);
    xhr.setRequestHeader('x-amz-acl', 'public-read');
    xhr.onload = function() {
        if (xhr.status === 200) {
            file_uploaded(url);
        }
    };
    xhr.onerror = function() {
        alert("Could not upload file.");
    };
    xhr.send(file);
}

function file_uploaded(url) {
    product.images.push(url);
    renderImages();

    $.ajax({
        type: 'POST',
        url: '/api/add-user-upload',
        data: {
            'url': url,
            'product': {{product.id}},
        },
        success: function(data) {},
        error: function(data) {},
    });
}
{% endif %}

function renderImages() {
    $('#var-images').empty();
    $.each(product.images, function (i, el) {
        if(i!=0&&i%4==0) {
            $('#var-images').append($('<div class="col-xs-12"></div>'));
        }

        var d = $('<div>', {'class':'col-xs-3 var-image-block','image-url': el});
        var img = $('<img>', {src: el, 'class': 'var-image', 'image-url': el, 'image-id':i, 'style':'cursor: default'});
        d.append(img);
        d.append($('<button class="btn btn-danger  btn-xs" style="display:none;position: absolute;cursor: pointer;right: 25px;top: 5px;background-color: rgb(247, 203, 203);color: #B51B18;border-radius: 5px;font-weight: bolder;">x</button>'));

        d.find('button').click(imageClicked);

        d.mouseenter(function() {
            $(this).find('button').show();
        })
        .mouseleave(function() {
            $(this).find('button').fadeOut();
        })

        $('#var-images').append(d);
    });

    matchImagesWithExtra();
}
var product_extra_images = [
{% for item in original.extra_images %}
        "{{item}}",
{% endfor %}
];

$(function() {
    showProductInfo(product);

    var element = document.querySelector("#trix-notes");
    element.editor.setSelectedRange([0, 0])
    element.editor.insertHTML('{{product.notes|escapejs}}');
});

$(function() {
    $("#uploader").plupload({
        // General settings
        runtimes : 'html5,flash',
        // Flash settings
        flash_swf_url : '//cdnjs.cloudflare.com/ajax/libs/plupload/2.1.8/Moxie.swf',
        // S3 specific settings
        url : "https://{{aws_bucket}}.s3.amazonaws.com:443/",
        file_name_name: false, // Custom option to our fork to remove file_name_name
        multipart: true,
        multipart_params : {
          // Dummy filename to ensure the field is sent in HTML just like Flash
          // This allow to have a consistent AWS policy for both HTML and Flash
          filename: 'filename',
          utf8: true,
          AWSAccessKeyId: "{{aws_key}}",
          acl: "public-read", // See http://docs.aws.amazon.com/AmazonS3/latest/dev/ACLOverview.html#CannedACL
          // See Generating a policy and a signature
          policy: "{{aws_policy|escapejs}}",
          signature: "{{aws_signature|escapejs}}",
          // This is basically the resulting location of the file on S3.
          // See http://docs.aws.amazon.com/AmazonS3/latest/API/RESTObjectPOST.html#RESTObjectPOST-requests-form-fields
          //
          // WARNING : Change this to suite your needs.
          // You need to insert some sort of unique identifier to avoid
          // overriding files if they share the same filename.
          key: "uploads/u{{user.id}}/${filename}",
          'Content-Type': 'image/jpeg',
        },
        filters : {
            // Maximum file size
            max_file_size : '3mb',
            // Specify what files to browse for
            mime_types: [
                {title : "Image files", extensions : "png,jpg,jpeg,gif"}
            ]
        },
        views: {
            list: true,
            thumbs: true, // Show thumbs
            active: 'thumbs'
        },
        sortable: true,
        dragdrop: true,
        init: {
            BeforeUpload: function(up, file) {
                up.settings.multipart_params['Content-Type'] = file.type;
            },
            FileUploaded: function(up, file, info) {
                var url = 'http://{{aws_bucket}}.s3.amazonaws.com/uploads/u{{user.id}}/'+file.name;
                file_uploaded(url);
            },
            UploadComplete: function(up, files){
                $('#modal-upload-image').modal('hide');
            }
        }
    });
});

</script>
{% endblock %}

