{% extends "base.html" %}

{% load static %}
{% load template_helper %}
{% load perms_helper %}
{% load url_tools %}
{% load compress %}

{% block main-container %}

    <div class="tabs-container">
        {% include 'home/partial/tabs/orders_track.html' %}
        <div class="tab-content">
            <div id="tab-1" class="tab-pane active">
                <div class="panel-body">
                    <div class="row m-b">
                        <div class="col-md-4">
                            <button class="btn btn-success btn-rounded btn-sm filter-btn">Filter</button>
                            {% if not paginator.is_infinte %}
                            <span class="btn btn-white btn-rounded btn-sm">Tracking count: {{paginator.count}} </span>
                            {% endif %}
                        </div>

                        <div class="col-md-6 col-md-offset-2 text-right">
                            {% if request.user|can:'order_imports.use' %}
                            <a class="btn btn-outline btn-default btn-rounded btn-sm itooltip m-r-xs"
                                title="Import Tracking IDs"
                                href="{% url 'order_imports_index' %}"><i class="fa fa-download"></i> Import</a>
                            {% endif %}

                            {% if not request.user.is_subuser %}
                            <a class="btn btn-outline btn-default btn-rounded btn-sm itooltip m-r-xs export-tracked-orders"
                                title="Clicking Export will export this page with Tracking numbers to a CSV file" data-store="{{ store.id }}"><i class="fa fa-upload"></i> Export </a>
                            {% endif %}

                            <div class="btn-group ">
                                <button data-toggle="dropdown" class="btn btn-default btn-outline btn-rounded btn-sm dropdown-toggle m-r-xs" aria-expanded="false">
                                    <i class="fa fa-cog"></i> Bulk Actions <span class="caret"></span></button>
                                <ul class="dropdown-menu">

                                    <li>
                                        <a class="btn-success btn-outline sync-selected-btn" store-id="{{store.id}}">
                                            <i class="fa fa-refresh"></i> Sync Selected Orders
                                        </a>
                                    </li>

                                    <li>
                                        <a class="btn-danger btn-outline delete-order-id-btn" store-id="{{store.id}}">
                                            <i class="fa fa-times"></i> Delete Order IDs
                                        </a>
                                    </li>

                                    <li>
                                        <a class="archive-selected-orders-btn" store-id="{{store.id}}">
                                            <i class="fa fa-archive"></i> Archive Orders
                                        </a>
                                    </li>
                                    </ul>
                            </div>

                            <button class="btn btn-success btn-rounded btn-outline btn-sm itooltip aliexpress-sync-btn" data-store="{{store.id}}"
                            title="Click Sync with Supplier to fetch order updates from AliExpress & eBay.">
                                <i class="fa fa-refresh"></i> Sync with Supplier</button>
                        </div>
                    </div>
                    <form method="get" action="{% url 'orders_track' %}" class="filter-form m-t-sm"
                        {% if request.COOKIES.orders_filter != 'true' %}
                              style="display:none"
                        {% endif %}
                    >

                    <div class="row">
                       <div class="col-md-3" style="width: 180px;margin-right: 0;padding-right: 0">
                           <label>Date Range:</label>
                       </div>
                       <div class="col-md-4">
                           <div id="date" class="form-control">
                               <i class="fa fa-calendar m-r-xs"></i>
                               <span>All Time</span>
                               <b class="caret pull-right" style="position:relative;right:-7px;top:8px;"></b>
                           </div>
                           <input type="hidden" type="text" name="date" value="{{ date|default:'' }}" />
                       </div>
                       <div class="col-md-6" style="">
                           <span class="help-block "></span>
                       </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3" style="width: 180px;margin-right: 0;padding-right: 0">
                            <label>Query:</label>
                        </div>
                        <div class="col-md-4">
                            <input name="query" value="{{request.GET.query|default:''}}" class="form-control" style="xpadding: 6px 0px" placeholder="Order ID or Tracking number">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3" style="width: 180px;margin-right: 0;padding-right: 0">
                            <label>Tracking #:</label>
                        </div>
                        <div class="col-md-2">
                            <select name="tracking" class="form-control" style="padding: 6px 0px">
                                <option {% if request.GET.tracking != '0' and  request.GET.tracking != '1' %}selected="selected"{% endif %} value="">Any</option>
                                <option {% if request.GET.tracking == '1' %}selected="selected"{% endif %} value="1">Has Tracking #</option>
                                <option {% if request.GET.tracking == '0' %}selected="selected"{% endif %} value="0">No Tracking #</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3" style="width: 180px;margin-right: 0;padding-right: 0">
                            <label>Shopify Status:</label>
                        </div>
                        <div class="col-md-2">
                            <select name="fulfillment" class="form-control" style="padding: 6px 0px">
                                <option {% if not request.GET.fulfillment  or request.GET.fulfillment == '2' %}selected="selected"{% endif %} value="2">Any</option>
                                <option {% if request.GET.fulfillment == '1' %}selected="selected"{% endif %} value="1">Fulfilled</option>
                                <option {% if request.GET.fulfillment == '0' %}selected="selected"{% endif %} value="0">Not Fulfilled</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3" style="width: 180px;margin-right: 0;padding-right: 0">
                            <label>Supplier Status:</label>
                        </div>
                        <div class="col-md-2">
                            <select name="reason" class="form-control" style="padding: 6px 0px" data-placeholder="Any">
                                <option value=""></option>
                                <optgroup label="Order Status">
                                    <option {% if reason == '_PLACE_ORDER_SUCCESS' %}selected="selected"{% endif %} value="_PLACE_ORDER_SUCCESS">Awaiting Payment</option>
                                    <option {% if reason == '_IN_CANCEL' %}selected="selected"{% endif %} value="_IN_CANCEL">Awaiting Cancellation</option>
                                    <option {% if reason == '_WAIT_SELLER_SEND_GOODS' %}selected="selected"{% endif %} value="_WAIT_SELLER_SEND_GOODS">Awaiting Shipment</option>
                                    <option {% if reason == '_SELLER_PART_SEND_GOODS' %}selected="selected"{% endif %} value="_SELLER_PART_SEND_GOODS">Partial Shipment</option>
                                    <option {% if reason == '_WAIT_BUYER_ACCEPT_GOODS' %}selected="selected"{% endif %} value="_WAIT_BUYER_ACCEPT_GOODS">Awaiting delivery</option>
                                    <option {% if reason == '_WAIT_GROUP_SUCCESS' %}selected="selected"{% endif %} value="_WAIT_GROUP_SUCCESS">Pending operation success</option>
                                    <option {% if reason == '_FINISH' %}selected="selected"{% endif %} value="_FINISH">Order Completed</option>
                                    <option {% if reason == '_IN_ISSUE' %}selected="selected"{% endif %} value="_IN_ISSUE">Dispute Orders</option>
                                    <option {% if reason == '_IN_FROZEN' %}selected="selected"{% endif %} value="_IN_FROZEN">Frozen Orders</option>
                                    <option {% if reason == '_WAIT_SELLER_EXAMINE_MONEY' %}selected="selected"{% endif %} value="_WAIT_SELLER_EXAMINE_MONEY">Payment not yet confirmed</option>
                                    <option {% if reason == '_RISK_CONTROL' %}selected="selected"{% endif %} value="_RISK_CONTROL">Payment being verified</option>
                                    <option {% if reason == '_IN_PRESELL_PROMOTION' %}selected="selected"{% endif %} value="_IN_PRESELL_PROMOTION">Promotion is on</option>
                                    <option {% if reason == '_FUND_PROCESSING' %}selected="selected"{% endif %} value="_FUND_PROCESSING">Fund Processing</option>
                                </optgroup>

                                <optgroup label="Order Cancellation Reason">
                                    {% for key, value in rejected_status.items %}
                                    <option {% if reason == key %}selected="selected"{% endif %}
                                            value="{{ key }}">{{ value }}</option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3" style="width: 180px;margin-right: 0;padding-right: 0">
                            <label>Order Errors:</label>
                        </div>
                        <div class="col-md-2">
                            <select name="errors" class="form-control" style="padding: 6px 0px" data-placeholder="Errors Filter" multiple>
                                <option value=""></option>
                                <option {% if 'none' in errors %}selected="selected"{% endif %} value="none">No Errors</option>
                                <option {% if 'any' in errors %}selected="selected"{% endif %} value="any">Any Errors</option>
                                <option {% if 'pending' in errors %}selected="selected"{% endif %} value="pending">Pending Errors Verification</option>
                                <option {% if '1' in errors %}selected="selected"{% endif %} value="1">Customer Name</option>
                                <option {% if '2' in errors %}selected="selected"{% endif %} value="2">Customer City</option>
                                <option {% if '4' in errors %}selected="selected"{% endif %} value="4">Customer Country</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3" style="width: 180px;margin-right: 0;padding-right: 0">
                            <label>Archived:</label>
                        </div>
                        <div class="col-md-2">
                            <select name="hidden" class="form-control" style="padding: 6px 0px">
                                <option {% if request.GET.hidden == '2' %}selected="selected"{% endif %} value="2">Any</option>
                                <option {% if not request.GET.hidden or request.GET.hidden == '0' %}selected="selected"{% endif %} value="0">Not Archived</option>
                                <option {% if request.GET.hidden == '1' %}selected="selected"{% endif %} value="1">Archived</option>
                            </select>
                        </div>
                    </div>

                    <div class="row m-t">
                        <div class="col-md-2" style="width: 180px;margin-right: 0;padding-right: 0">
                            <label>Number of Days Passed:</label>
                        </div>
                        <div class="col-md-2">
                            <input name="days_passed" type="number" max="360" value="{{request.GET.days_passed|default:''}}" class="form-control" style="xpadding: 6px 0px" placeholder="Number of Days Passed">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-2" style="width: 150px;margin-right: 0;padding-right: 0">
                            {% if request.GET.store %}  <input type="hidden" name="store" value="{{ request.GET.store }}"> {% endif %}
                            {% if request.GET.sort %}   <input type="hidden" name="sort" value="{{ request.GET.sort }}"> {% endif %}

                            <button class="btn btn-primary">Apply</button>
                        </div>
                    </div>
                    <hr >
                    </form>

                    <table class="table table-condensed xtable-hover">
                      <thead>
                        <tr>
                          <th style="width:64px">
                              <div class="row">
                                  <div class="col-md-12">
                                    <input type="checkbox" class="icheck check-all" name="check-all">
                                  </div>
                              </div>
                          </th>
                          <th  class="no-wrap" style="width:26%">
                              <a href="{% url_toggle 'sort' '-order,order' %}">Shopify Order {% sort_icon 'sort' 'order' %}</a></th>
                          <th class="no-wrap"><a href="{% url_toggle 'sort' '-source,source' %}">Supplier Order {% sort_icon 'sort' 'source' %}</a></th>
                          <th class="no-wrap"><a href="{% url_toggle 'sort' '-status,status' %}">Supplier Status {% sort_icon 'sort' 'status' %}</a></th>
                          <th class="no-wrap"><a href="{% url_toggle 'sort' '-tracking,tracking' %}">Tracking Number {% sort_icon 'sort' 'tracking' %}</a></th>
                          <th class="no-wrap"><a href="{% url_toggle 'sort' '-add,add' %}">Order Date {% sort_icon 'sort' 'add' %}</a></th>
                          <th class="no-wrap"><a href="{% url_toggle 'sort' '-update,update' %}">Updated {% sort_icon 'sort' 'update' %}</a></th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for item in orders %}
                        <tr id="{{item.id}}"
                            {% if item.errors > 0 %}style="background-color:#ffcfd4"{% endif %}
                            {% if order_threshold and item.created_at < order_threshold and not item.source_tracking %}class="highlight"{% endif %}
                        >
                            <td style="min-width:30px">
                                <div class="row">
                                    <div class="col-md-12">
                                        <img class="no-img no-img-sm unveil visible-md-inline visible-lg-inline"
                                            store="{{item.store_id}}" product="{{item.line.product_id}}" variant="{{item.line.variant_id}}"
                                            src="{% static 'img/blank.gif' %}"
                                            data-src="/api/product-variant-image?store={{item.store_id}}&product={{item.line.product_id}}&variant={{item.line.variant_id}}&redirect=1&thumb=1"
                                            style="width:64px" />
                                            <input type="checkbox" class="icheck order-track" name="track" value="{{item.id}}"
                                                track-id="{{item.id}}" order-id="{{item.order_id}}" line-id="{{item.line_id}}">
                                    </div>
                                </div>
                            </td>
                            <td>
                                <a class="itooltip" href="{{item.get_shopify_link}}" target="_blank" title="{{item.line.title}}">
                                    <span class="badge badge-primary">{{item.order.name}}</span>
                                    <span class="m-l-xs visible-lg-inline">
                                        {{item.line.title|truncatewords:10}}
                                    </span>
                                </a>
                            </td>
                            <td><a href="{{item.get_source_url}}" target="_blank">#{{item.source_id}}</a></td>
                            <td>{% order_track_status item %}</td>
                            <td>{% order_track_tracking_urls item %}</td>

                            <td class="no-wrap">{% date_humanize item.created_at %}</td>
                            <td class="no-wrap">{% date_humanize item.updated_at %}</td>
                            <td class="no-wrap">
                                {% if item.errors > 0 %}
                                <span class="badge badge-warning" qtip-my="right center" qtip-at="left center"
                                    qtip-tooltip="{{item.get_errors_details|join:'<br>'}}">
                                    {{item.get_errors|join:", "}}
                                </span>
                                {% endif %}

                                {% if item.line.fulfillment_status != 'fulfilled' %}
                                <button class="btn btn-success btn-xs fulfill-btn itooltip"
                                        store="{{item.store_id}}"
                                        order-id="{{item.order.id}}"
                                        line-id="{{item.line.id}}"
                                        quantity="{{item.line.quantity}}"
                                        tracking-number="{{item.source_tracking|default:''}}"
                                        title="Fulfill this item in Shopify"
                                        >Fulfill</button>
                                {% else %}
                                    <span class="badge badge-primary">
                                        {{item.line.fulfillment_status|default:"Unfulfilled"|title}}
                                    </span>
                                {% endif %}

                                {% if item.auto_fulfilled %}
                                    <span class="badge badge-primary itooltip" title="Item was Automatically fulfilled by Dropified">Auto</span>
                                {% endif %}

                                {% if item.hidden %}
                                <button order-id="{{item.id}}" class="btn btn-success btn-xs btn-outline show-order">Un-Archive</button>
                                {% else %}
                                <button order-id="{{item.id}}" class="btn btn-info btn-xs btn-outline hide-order itooltip"
                                        title="Archive in Tracking page">Archive</button>
                                {% endif %}

                                <button store="{{item.store_id}}" order-id="{{item.order.id}}" line-id="{{item.line.id}}"
                                        class="btn btn-info btn-xs btn-outline track-details itooltip">
                                    Details
                                </button>

                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td class="text-center" colspan="7">
                                {% if request.GET.query %}
                                    No tracked orders found for: <b>{{request.GET.query}}</b>
                                {% else %}
                                    No tracked orders found.
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                  </table>

                  {% include "partial/paginator.html" %}
                </div>
            </div>
        </div>
    </div>

    <div id="modal-tracking-details" class="modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            </div>
        </div>
    </div>

{% include 'partial/fulfillment_modal.html' with store=store notify=True only %}
{% include 'partial/tracking_update_modal.html' with store=store only %}

{% endblock %}

{% block extracss %}

{% compress css %}
<link href="{% static 'libs/bower_components/bootstrap-daterangepicker/daterangepicker.css' %}" rel="stylesheet">
<style type="text/css">
    .icheckbox_square-blue {
        position: initial !important;
        margin: 0 !important;
    }
    table tbody .icheckbox_square-blue {
        position: absolute !important;
        top: 0px;
        left: 15px;
    }
    .highlight {
        background-color: rgb(230, 213, 213);
    }
    .filter-form .row {
        padding-bottom: 5px;
        display: flex;
        align-items: center;
    }
</style>
{% endcompress %}

{% endblock %}

{% block extrajs %}
<script type="text/javascript">
    window.store = {
        type: 'shopify',
        id: '{{ store.id }}',
    }
</script>

{% compress js %}
    <script src="{% static 'libs/bower_components/moment/min/moment.min.js' %}"></script>
    <script src="{% static 'libs/bower_components/bootstrap-daterangepicker/daterangepicker.js' %}"></script>
    <script src="{% static 'libs/bower_components/handlebars/handlebars.min.js' %}" type="text/javascript" ></script>
    <script src="{% static 'js/daterangepicker.js' %}" type="text/javascript"></script>
    <script src="{% static 'prints/js/track_orders.js' %}" type="text/javascript"></script>
    <script src="{% static 'shopified/js/orders_track.js' %}" type="text/javascript"></script>
    <script src="{% static 'shopified/js/orders_track_update.js' %}" type="text/javascript"></script>
{% endcompress %}

{% endblock %}
