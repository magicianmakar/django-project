{% extends "base.html" %}

{% load static %}

{% block main-container %}

    <div class="tabs-container">
        <ul class="nav nav-tabs">
            {% for item in user.profile.get_active_stores %}
                {% if store == item or item.id|stringformat:"i" == request.GET.store %}
                    <li class="active"><a data-toggle="tab" href="#tab-1" aria-expanded="true">{{item.title}}</a></li>
                {% else %}
                    <li class=""><a href="/orders?store={{item.id}}" aria-expanded="false">{{item.title}}</a></li>
                {% endif %}
            {% endfor %}
        </ul>
        <div class="tab-content">
            <div id="tab-1" class="tab-pane active">
                <div class="panel-body">
                    <button class="btn btn-success btn-rounded filter-btn pull-right">Filter &amp; Sort</button>
                    <form method="get" action="/orders" class="filter-form" style="display:none">
                    <div class="row">
                        <div class="col-md-2" style="width: 150px;margin-right: 0;padding-right: 0">
                            <label>Sort:</label>
                        </div>
                        <div class="col-md-3">
                            <select name="sort" class="form-control" style="padding: 6px 0px">
                                <option {% if sort == 'asc' %}selected="selected"{% endif %}value="asc">Newst orders first</option>
                                <option {% if sort == 'desc' %}selected="selected"{% endif %}value="desc">Oldest orders first</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2" style="width: 150px;margin-right: 0;padding-right: 0">
                            <label>Status:</label>
                        </div>
                        <div class="col-md-3">
                            <select name="status" class="form-control" style="padding: 6px 0px">
                                <option {% if status == 'open' %}selected="selected"{% endif %}value="open">All open orders</option>
                                <option {% if status == 'closed' %}selected="selected"{% endif %}value="closed">Show only closed orders</option>
                                <option {% if status == 'cancelled' %}selected="selected"{% endif %}value="cancelled">Show only cancelled orders</option>
                                <option {% if status == 'any' %}selected="selected"{% endif %}value="any">Any order status</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2" style="width: 150px;margin-right: 0;padding-right: 0">
                            <label>Fulfillment Status:</label>
                        </div>
                        <div class="col-md-4">
                            <select name="fulfillment" class="form-control" style="padding: 6px 0px">
                                <option {% if fulfillment == 'unshipped' %}selected="selected"{% endif %}value="unshipped">Show orders that have not yet been shipped</option>
                                <option {% if fulfillment == 'shipped' %}selected="selected"{% endif %}value="shipped">Show orders that have been shipped</option>
                                <option {% if fulfillment == 'partial' %}selected="selected"{% endif %}value="partial">Show partially shipped orders</option>
                                <option {% if fulfillment == 'any' %}selected="selected"{% endif %}value="any">Show orders with any fulfillment status</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2" style="width: 150px;margin-right: 0;padding-right: 0">
                            <label>Financial Status:</label>
                        </div>
                        <div class="col-md-4">
                            <select name="financial" class="form-control" style="padding: 6px 0px">
                                <option value="any" {% if financial == 'any' %}selected="selected"{% endif %}>Show all authorized, pending, and paid orders</option>
                                <option value="authorized" {% if financial == 'authorized' %}selected="selected"{% endif %}>Show only authorized orders</option>
                                <option value="pending" {% if financial == 'pending' %}selected="selected"{% endif %}>Show only pending orders</option>
                                <option value="paid" {% if financial == 'paid' %}selected="selected"{% endif %}>Show only paid orders</option>
                                <option value="partially_paid" {% if financial == 'partially_paid' %}selected="selected"{% endif %}>Show only partially paid orders</option>
                                <option value="refunded" {% if financial == 'refunded' %}selected="selected"{% endif %}>Show only refunded orders</option>
                                <option value="voided" {% if financial == 'voided' %}selected="selected"{% endif %}>Show only voided orders</option>
                                <!-- <option value="partially_refunded" {% if financial == 'partially_refunded' %}selected="selected"{% endif %}>Show only partially refunded orders</option> -->
                                <option value="unpaid" {% if financial == 'unpaid' %}selected="selected"{% endif %}>Show all authorized, or partially paid orders</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-2" style="width: 150px;margin-right: 0;padding-right: 0">
                            {% if request.GET.store %}
                            <input type="hidden" name="store" value="{{ request.GET.store }}">
                            {% endif %}
                        <button class="btn btn-primary">Apply</button>
                        </div>
                    </div>
                    <hr >
                    </form>
                    <table class="table table-condensed table-hover">
                      <thead>
                        <tr>
                          <th>Order #</th>
                          <th>Date</th>
                          <th>Customer</th>
                          <th>Payment Status</th>
                          <th>Fulfillment Status</th>
                          <th>Total</th>
                        </tr>
                      </thead>
                      <tbody>
                            {% for order in orders %}
                            <tr>
                                <td>
                                    <a href="#" class="more-info"><i class="fa fa-plus" style="margin-right:10px"></i></a>
                                    <a href="{{order.order_url}}" target="_blank">
                                        {{order.name}}
                                        {% if not request.GET.store %}
                                        | {{ order.store.title }}
                                        {% endif %}
                                    </a>
                                </td>
                                <td>{{order.date_str}}</td>
                                <td>{{order.customer.first_name}} {{order.customer.last_name}}</td>
                                <td>{{order.financial_status|title}}</td>
                                <td>
                                    {% if not order.fulfillment_status %}
                                        <span class="label label-warning">Unfulfilled</span>
                                    {% else %}
                                        <span class="label label-success">{{order.fulfillment_status|title}}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <b>{% if order.currency == 'USD' %} ${% else %} {{order.currency}} {% endif %}{{order.total_price}}</b>
                                </td>
                            </tr>

                            <tr class="var-info" style="display:none">
                                <td colspan="6">
                                    <table class="table table-condensed xtable-hover xtable-bordered">
                                        <thead>
                                            <tr>
                                                <th>Product</th>
                                                <th style="width:310px"></th>
                                                <th>Variant</th>
                                                <th>Qty</th>
                                                <th>Vendor</th>
                                                <th></th>
                                                <th></th>
                                                <th style="width:200px">Shipping Address</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in order.line_items %}
                                            {% with image=item.image original=item.product.get_original_info %}
                                            <tr>
                                                <td>
                                                    <img
                                                    class="lazyload"
                                                    store="{{image.store}}"
                                                    product="{{image.product}}"
                                                    variant="{{image.variant}}"
                                                    {% if image %}
                                                    src=""
                                                    {% else %}
                                                    src="{{item.product.get_images|first}}"
                                                    {% endif %}
                                                    style="width:64px" />
                                                </td>
                                                <td>
                                                    {% if item.product %}
                                                    <a href="/product/{{item.product.id}}" target="_blank">{{item.name}}</a>
                                                    {% else %}
                                                    {{item.name}}
                                                    {% endif %}
                                                </td>
                                                <td><a href="{{item.variant_link}}" target="_blank">{{item.variant_title}}</a></td>
                                                <td>
                                                    <span style="{% if item.quantity > 1 %} font-weight: bolder; color: blue{% endif %}">{{item.quantity}}</span>
                                                </td>
                                                <td>{{item.vendor}}</td>
                                                <td class="text-center">
                                                    {% if original %}
                                                        <a href="{{item.original_url}}" target="_blank" class="btn btn-success btn-xs itooltip"  data-toggle="tooltip" data-placement="top" title="Sourced from: {{original.source}}">Place Order</a>
                                                        {% if item.order_data %}
                                                        <br />

                                                        <a href="{{item.original_url}}?SAPlaceOrder={{ item.order_data|urlencode }}" target="_blank" class="btn btn-info btn-xs itooltip m-t-xs" data-toggle="tooltip" data-placement="top" title="Select variant and quantity and fill shipping address automatically">Auto Place Order</a>
                                                        {% endif %}
                                                    {% else %}
                                                    <span class="label label-warning">Not Tracked</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                {% if not item.fulfillment_status %}
                                                    <button class="btn btn-xs btn-default fulfill-btn" quantity="{{item.quantity}}" order-id="{{order.id}}" line-id="{{item.id}}" store="{{order.store.id}}">Unfulfilled</button>
                                                {% else %}
                                                    <span class="label label-success">{{item.fulfillment_status|title}}</span>
                                                {% endif %}
                                                </td>
                                                {% if forloop.counter0 == 0 %}
                                                <td rowspan="{{order.line_items|length}}">
                                                    {{order.shipping_address.address1}}<br>
                                                    {{order.shipping_address.address2}}{% if order.shipping_address.address2 %}<br>{% endif %}
                                                    {{order.shipping_address.city}}, {{order.shipping_address.province_code}} {{order.shipping_address.zip}}
                                                    {% if order.shipping_address.country_code != 'US' %}
                                                    <br> <b>{{order.shipping_address.country}}</b>
                                                    {% endif %}
                                                    <br>
                                                </td>
                                                {% endif %}
                                            </tr>
                                            {% endwith %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </td>
                            </tr>


                            {% empty %}
                            <tr>
                              <td colspan="6" class="text-center">No orders found.</td>
                            </tr>
                            {% endfor %}
                      </tbody>
                    </table>

                    <h4>Orders count: {{open_orders}}</h4>

                    {% include "partial/paginator.html" %}
                </div>
            </div>
        </div>
    </div>

<div id="modal-fulfillment" class="modal fade" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-6 b-r"><h3 class="m-t-none m-b">Change Fulfillment Status</h3>

                        <form role="form">
                            <div class="form-group">
                                <label>Quantity</label>
                                <input type="text" id="fulfill-quantity" name="fulfill-quantity" class="form-control">
                            </div>

                            <div class="form-group">
                                <label>Tracking Number</label>
                                <input type="text" id="fulfill-traking-number" name="fulfill-traking-number" class="form-control">
                            </div>

                            <div>
                                <input type="hidden" id="fulfill-order-id" name="fulfill-order-id" class="form-control">
                                <input type="hidden" id="fulfill-line-id" name="fulfill-line-id" class="form-control">
                                <input type="hidden" id="fulfill-store" name="fulfill-store" class="form-control">

                                <button id="fullfill-order-btn" class="btn btn-sm btn-primary pull-right m-t-n-xs" type="button"><strong>Fulfill Order</strong></button>
                            </div>
                        </form>
                    </div>
                    <div class="col-sm-6">
                        <h4>Fulfill order</h4>
                        <p class="">
                            Partially fulfill a single line item by explicitly specifying the line item and quantity to be fulfilled.
                        </p>
                        <p>If you don't have a Tracking Number, leave that field blank.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extrajs %}
<script type="text/javascript">

    var image_cache = {};

    $(function () {
        $(".itooltip").tooltip();
    });

    $(".more-info").click(function (e) {
        e.preventDefault();

        var element = $(this).find('i');
        var target = $(this).parents('tr').next();

        $('.lazyload', target).each(function (i, el) {
            if (!$(el).prop('image-loaded')) {
                var cache_name = $(el).attr('store')+'|'+$(el).attr('product')+'|'+$(el).attr('variant');

                if (cache_name in image_cache) {
                    $(el).attr('src', image_cache[cache_name]);
                    return;
                }

                $.ajax({
                    url: '/api/product-variant-image',
                    type: 'GET',
                    data: {
                        store: $(el).attr('store'),
                        product: $(el).attr('product'),
                        variant: $(el).attr('variant'),
                    },
                    context: {img: $(el), cache_name: cache_name},
                    success: function (data) {
                        if (data.status == 'ok') {
                            this.img.attr('src', data.image);

                            image_cache[cache_name] = data.image;
                        }
                    },
                    error: function (data) {
                    },
                    complete: function () {
                        this.img.prop('image-loaded', true);
                    }
                });
            }
        });

        target.toggle('fade', function() {
            if (target.is(":visible")) {
                element.removeClass('fa-plus');
                element.addClass('fa-minus');
            } else {
                element.removeClass('fa-minus');
                element.addClass('fa-plus');
            }
        });
    });

    $('.fulfill-btn').click(function (e) {
        $('#modal-fulfillment #fulfill-quantity').val($(this).attr('quantity'));
        $('#modal-fulfillment #fulfill-order-id').val($(this).attr('order-id'));
        $('#modal-fulfillment #fulfill-line-id').val($(this).attr('line-id'));
        $('#modal-fulfillment #fulfill-store').val($(this).attr('store'));

         if ($(this).prop('fulfilled')) {
            return;
        };

        $('#modal-fulfillment').modal('show');
    });

    $('#fullfill-order-btn').click(function (e) {
        e.preventDefault();

        $(this).button('loading');
        var line_btn = $('.fulfill-btn[line-id="'+$('#modal-fulfillment #fulfill-line-id').val()+'"]');

        $.ajax({
            url: '/api/fulfill-order',
            type: 'POST',
            data:  $('#modal-fulfillment form').serialize(),
            context: {btn: $(this), line: line_btn},
            success: function (data) {
                if (data.status == 'ok') {
                    $('#modal-fulfillment').modal('hide');
                    swal('Fulfillment Status', 'Fulfillment Status changed to Fulfilled', 'success');
                    this.line.prop('fulfilled', true);
                } else {
                    displayAjaxError('Fulfill Order', data);
                }
            },
            error: function (data) {
                displayAjaxError('Fulfill Order', data);
            },
            complete: function () {
                this.btn.button('reset');

                var btn = this.line;
                setTimeout(function() {
                    if (btn.prop('fulfilled')) {
                        btn.removeClass('btn-default');
                        btn.addClass('btn-success');
                        btn.text('Fulfilled');
                    }
                }, 100);
            }
        });
    });

    $('.filter-btn').click(function (e) {
        $('.filter-form').toggle('fade');
    });
</script>
{% endblock %}

