{% extends "base.html" %}

{% load static %}

{% block main-container %}

<div class="ibox float-e-margins">
<div class="ibox-title">
    <h5>Saved Products<small></small></h5>
    <div class="ibox-tools">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#" aria-expanded="false">
            <i class="fa fa-wrench"></i>
        </a>
        <ul class="dropdown-menu dropdown-user">
            <li><a href="/product/table">Table Layout</a> </li>
        </ul>

        <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
    </div>
</div>
<div class="ibox-content">

<div class="row">
    {% for item in products %}
    <div class="col-md-3">
        <div class="ibox">
            <div class="ibox-content product-box">

                <div class="product-imitation" style="padding: 0;">
                    <img src="{{item.images|first}}" style="width: 100%">
                </div>
                <div class="product-desc">
                    <span class="product-price">
                        {{item.price}}
                    </span>
                    <small class="text-muted">{{item.product.type}}</small>
                    <a href="/product/{{item.id}}" class="product-name"> {{item.product.title}}</a>

                    <div class="small m-t-xs">
                        Submitted at {{item.created_at|date}}
                    </div>
                    <div class="m-t text-righ">

                        <a href="/product/{{item.id}}" class="btn btn-xs btn-outline btn-primary"> Info <i class="fa fa-long-arrow-right"></i> </a>
                        {% if item.stat == 1 and item.shopify_url %}
                        <a href="{{item.shopify_url}}" class="btn btn-xs btn-outline btn-success" target="_blank"> <i class="fa fa-share"></i> Sent</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

</div>
</div>


{% endblock %}


{% block extrajs %}
<script type="text/javascript">
    $('#add-store').click(function(e) {
        var url = $('#store-url').val().match(/[^\*:/]{10,}:[^\*:]{10,}@[^\.]+\.myshopify\.com/);

        if (!url || url.length != 1) {
            alert('API URL is not correct!');
            return;
        }

        $('#add-store').button('loading');

        $.ajax({
            url: '/api/add-store',
            type: 'POST',
            data: {
                name: $('#store-name').val(),
                url: 'https://' + url[0],
            },
            success: function(data) {
                if ('error' in data) {
                    alert(data.error);
                    $('#add-store').button('reset');
                } else {
                    window.location.href = window.location.href
                }

            },
            error: function(data) {
                alert('Unknow error!');
                $('#add-store').button('reset');
            }
        });
    });

    $('.delete-store').click(function (e) {
        var btn = $(this);
        var url = $(this).attr('store-url');

        btn.button('loading');

        $.ajax({
            url: '/api/delete-store',
            type: 'POST',
            data: {
                url: url,
            },
            success: function(data) {
                if ('error' in data) {
                    alert(data.error);
                    btn.button('reset');
                } else {
                    btn.parents('tr').remove();
                }

            },
            error: function(data) {
                alert('Connection error');
                btn.button('reset');
            }
        });
    });

    $('.visit-store').click(function(e) {
        var url = $(this).attr('store-url');
        url = url.replace(/[^\/:]+:[^:]+@/, '') + '/admin';

        window.open(url, '_target');
    });

</script>
{% endblock %}

