{% extends "base.html" %}

{% load static %}

{% block main-container %}

<div class="ibox float-e-margins">
<div class="ibox-title">
    <h5>Saved Products<small></small></h5>
    <div class="ibox-tools">
        <a href="/product/table" title="Table Layout"><i class="fa fa-lg fa-list"></i></a>
        <a style="color: rgba(0, 0, 0, 0.76)" title="Grid Layout"><i class="fa fa-lg fa-th"></i></a>
    </div>
</div>
<div class="ibox-content">

<div class="row">
    {% for item in products %}
    <div class="col-md-3">
        <div class="ibox">
            <div class="ibox-content product-box">

                <div class="product-imitation" style="padding: 0;">
                    <img src="{{item.images|first}}" style="width: 100%">
                </div>
                <div class="product-desc">
                    <span class="product-price">
                        {{item.price}}
                    </span>
                    <small class="text-muted">{{item.product.type}}</small>
                    <a href="/product/{{item.id}}" class="product-name"> {{item.product.title}}</a>

                    <div class="small m-t-xs">
                        Submitted at {{item.created_at|date}}
                    </div>
                    <div class="m-t text-righ">

                        <a href="/product/{{item.id}}" class="btn btn-xs btn-outline btn-primary"> Info <i class="fa fa-long-arrow-right"></i> </a>
                        {% if item.stat == 1 %}
                        <button product-id="{{item.id}}" class="btn btn-xs btn-outline btn-success sent-btn" target="_blank"> <i class="fa fa-share"></i> <span>Sent</span></button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

</div>
</div>


{% endblock %}


{% block extrajs %}
<script type="text/javascript">
    $('#add-store').click(function(e) {
        var url = $('#store-url').val().match(/[^\*:/]{10,}:[^\*:]{10,}@[^\.]+\.myshopify\.com/);

        if (!url || url.length != 1) {
            alert('API URL is not correct!');
            return;
        }

        $('#add-store').button('loading');

        $.ajax({
            url: '/api/add-store',
            type: 'POST',
            data: {
                name: $('#store-name').val(),
                url: 'https://' + url[0],
            },
            success: function(data) {
                if ('error' in data) {
                    alert(data.error);
                    $('#add-store').button('reset');
                } else {
                    window.location.href = window.location.href
                }

            },
            error: function(data) {
                alert('Unknow error!');
                $('#add-store').button('reset');
            }
        });
    });

    $('.delete-store').click(function (e) {
        var btn = $(this);
        var url = $(this).attr('store-url');

        btn.button('loading');

        $.ajax({
            url: '/api/delete-store',
            type: 'POST',
            data: {
                url: url,
            },
            success: function(data) {
                if ('error' in data) {
                    alert(data.error);
                    btn.button('reset');
                } else {
                    btn.parents('tr').remove();
                }

            },
            error: function(data) {
                alert('Connection error');
                btn.button('reset');
            }
        });
    });

    $('.visit-store').click(function(e) {
        var url = $(this).attr('store-url');
        url = url.replace(/[^\/:]+:[^:]+@/, '') + '/admin';

        window.open(url, '_target');
    });

    $('.sent-btn')
      .mouseenter(function() {
        $( 'span', this ).text( "Unsent" );
        $( this ).toggleClass( 'btn-success' );
        $( this ).toggleClass( 'btn-warning' );
      })
      .mouseleave(function() {
        $( 'span', this ).text( "Sent" );
        $( this ).toggleClass( 'btn-warning' );
        $( this ).toggleClass( 'btn-success' );
      })
      .click(function(e) {
        var btn = $(this);
        btn.button('loading');

        $.ajax({
            url: '/api/product',
            type: 'POST',
            data: {
                product: btn.attr('product-id'),
            },
            success: function(data) {
                if ('error' in data) {
                    alert(data.error);
                    btn.button('reset');
                } else {
                    btn.remove();
                }

            },
            error: function(data) {
                alert('Connection error');
                btn.button('reset');
            }
        });
      });

</script>
{% endblock %}

