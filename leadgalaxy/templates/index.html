{% extends "base.html" %}

{% load static %}

{% block main-container %}

    <div class="ibox float-e-margins">
        <div class="ibox-title">
            <h5>Shopify Stores<small></small></h5>
            <div class="ibox-tools">
                <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
            </div>
        </div>
        <div class="ibox-content">
            <div class="row">
                <div class="col-md-12">
            <table class="table table-condensed table-hover table-bordered">
              <thead>
                <tr>
                  <th style=";">Title</th>
                  <th class="hidden-sm hidden-xs" style=";">API URL</th>
                  <th style="width:90px">Products</th>
                  <th style="">Options</th>
                </tr>
              </thead>
              <tbody>
                    {% for item in stores %}
                    <tr store-id="{{item.id}}">
                      <td><a href="/store/{{item.id}}">{{item.title}}</a></td>
                      <td class="hidden-sm" >{{item.api_url}}</td>
                      <td>{{item.shopifyproduct_set.count}}</td>
                      <td>
                        <button class="visit-store btn btn-xs btn-success" store-url="{{item.api_url}}"> Visit Store</button>
                        <button class="delete-store btn btn-xs btn-danger" store-id="{{item.id}}" store-url="{{item.api_url}}"> Delete</button>
                      </td>
                    </tr>
                    {% empty %}
                    <tr>
                      <td colspan="3" class="text-center">No store found.</td>
                    </tr>
                    {% endfor %}
              </tbody>
            </table>

            <a data-toggle="modal" class="btn btn-primary" href="#modal-form">Add Store</a>
                </div>
            </div>

        </div>
    </div>

    <div class="ibox float-e-margins">
        <div class="ibox-title">
            <h5>Settings<small></small></h5>
            <div class="ibox-tools">
                <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
            </div>
        </div>
        <div class="ibox-content">
            <div class="row">
                <div class="col-md-12">
                    <form id="config-form" class="form-horizontal" role="form">
                      <div class="form-group">
                        <label for="auto_margin" class="col-sm-2 control-label">Auto Margin</label>
                        <div class="col-sm-2">
                          <input style="width:80px" type="text" class="form-control col-sm-2" id="auto_margin" name="auto_margin" value="{{user.profile.get_config.auto_margin}}">
                        </div>
                        <span class="help-block ">(For example: If you set Auto margin to <b>50%</b>, a product that costs $10.00 will be set to $15.00)</span>
                      </div>
                      <div class="form-group">
                        <label for="make_visisble" class="col-sm-2 control-label">Make Products Visible</label>
                        <div class="col-sm-10">
                          <input type="checkbox" class="form-control icheck" id="make_visisble" name="make_visisble"{% if user.profile.get_config.make_visisble %}checked="checked"{% endif %}>
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="default_desc" class="col-sm-2 control-label">Default Description</label>
                        <div class="col-sm-10">
                          <textarea name="default_desc" id="default_desc" cols="30" rows="10" class="form-control">{{user.profile.get_config.default_desc}}</textarea>
                        </div>
                      </div>
                      <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                          <button data-toggle="modal" class="btn btn-primary"><i class="fa fa-save"></i> Save</button>
                        </div>
                      </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

<div id="modal-form" class="modal fade" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-6 b-r"><h3 class="m-t-none m-b">Add Shopify Store</h3>

                        <form role="form">
                            <div class="form-group"><label>Name</label> <input type="text" id="store-name" placeholder="Enter Store Name" class="form-control"></div>
                            <div class="form-group"><label>API URL</label> <input type="text" id="store-url" placeholder="Copy/Past Example URL" class="form-control"></div>
                            <div>
                                <button id="add-store" class="btn btn-sm btn-primary pull-right m-t-n-xs" type="button"><strong>Add store</strong></button>
                            </div>
                        </form>
                    </div>
                    <div class="col-sm-6"><h4>Need Help?</h4>
                <p class="xwell">
                    How To Connect Your Shopify Store:
                    <ol>
                        <li>Create a "Shopify Private App"</li>
                        <li>Give a Friendly Store Name and paste the <b>Example URL</b> from your Private App.</li>
                    </ol>

                    <a href="http://f.cl.ly/items/3b001Z0x1e0I010F2z0q/Screen%20Recording%202015-10-20%20at%2001.03%20PM.gif" target="_blank">Watch Video Instructions</a>
                </p>
                </div>
            </div>
        </div>
        </div>
    </div>
</div>

<div id="modal-store-move" class="modal fade" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12">
                        <h3 class="m-t-none m-b">Delete Store</h3>
                        <p>Where to move the linked products in this store?</p>

                        <label for="">Select Store:</label>
                        <select class="form-control" name="" id="move-select-store" style="display: inline-block; width: 191px; ">
                            {% for item in stores %}
                            <option value="{{item.id}}">{{item.title}}</option>
                            {% endfor %}
                        </select>

                        <button id="store-move-btn" class="btn btn-primary" style="margin-bottom: 5px; margin-left: 25px;">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extrajs %}
<script type="text/javascript">
    $('#add-store').click(function(e) {
        var url = $('#store-url').val().match(/[^\*:/]{10,}:[^\*:]{10,}@[^\.]+\.myshopify\.com/);

        if (!url || url.length != 1) {
            alert('API URL is not correct!');
            return;
        }

        $('#add-store').button('loading');

        $.ajax({
            url: '/api/add-store',
            type: 'POST',
            data: {
                name: $('#store-name').val(),
                url: 'https://' + url[0],
            },
            success: function(data) {
                if ('error' in data) {
                    alert(data.error);
                    $('#add-store').button('reset');
                } else {
                    window.location.href = window.location.href
                }

            },
            error: function(data) {
                alert('Unknow error!');
                $('#add-store').button('reset');
            }
        });
    });


    $('.delete-store').click(function (e) {
        document.current_store = $(this).attr('store-id');
        $('#modal-store-move').modal('show');
    });

    $('#store-move-btn').click(function (e) {
        var btn = $(this);
        var store = parseInt(document.current_store);
        var move_to = parseInt($('#move-select-store').val());

        if (move_to <= 0) {
            swal('Delete Store', 'Please select a store', 'warning');
            return;
        }
        if (move_to == store) {
            swal('Delete Store', 'Please choose an other store ', 'warning');
            return;
        }

        btn.button('loading');

        $.ajax({
            url: '/api/delete-store',
            type: 'POST',
            data: {
                'store': store,
                'move-to': move_to
            },
            success: function(data) {
                if ('error' in data) {
                    swal('Delete Store', data.error, 'error');
                } else {
                    $('tr[store-id="'+store+'"]').remove();
                }
            },
            error: function(data) {
                swal('Delete Store', 'Server error', 'error');
            },
            complete: function () {
                $('#modal-store-move').modal('hide');
                btn.button('reset');
            }
        });
    });

    $('.visit-store').click(function(e) {
        var url = $(this).attr('store-url');
        url = url.replace(/[^\/:]+:[^:]+@/, '') + '/admin';

        window.open(url, '_target');
    });

    $('form#config-form').submit(function (e) {
        e.preventDefault();

        var config = $(this).serialize();

        $.ajax({
            url: '/api/user-config',
            type: 'POST',
            data: config,
            context: {form: $(this)},
            success: function (data) {
                if (data.status == 'ok') {
                    toastr.success('Saved.','User Config');
                } else {
                    swal('User Config', ('error' in data ? data.error : 'Unknow error'), 'error');
                }
            },
            error: function (data) {
                swal('User Config', 'Server error', 'error');
            },
            complete: function () {
            }
        });

        return false;
    });

</script>
{% endblock %}

